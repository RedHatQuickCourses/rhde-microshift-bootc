<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Create Bootc Container Images with MicroShift :: Deploying MicroShift on RHEL Image Mode</title>
    <link rel="prev" href="s1-microshift-bootc.html">
    <link rel="next" href="s4-summary.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Deploying MicroShift on RHEL Image Mode</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/rhde-microshift-bootc/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rhde-microshift-bootc" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Deploying MicroShift on RHEL Image Mode</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-microshift/index.html">Introduction to Red Hat Build of MicroShift</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-microshift/s1-microshift-vs-ocp.html">Introduction to MicroShift and Red Hat Device Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-microshift/s2-prepare-lab.html">Lab: Prepare a Test Environment for Image Mode and MicroShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-microshift/s3-air-gapped-lab.html">Lab: Prepare a Disconnected Environment for MicroShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-microshift/s4-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch2-package/index.html">Deploy MicroShift on RHEL Servers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-package/s1-install-config.html">Install and Configure MicroShift on Package-Based RHEL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-package/s2-install-lab.html">Lab: Install MicroShift from RPM Packages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-package/s3-access-lab.html">Lab: Access MicroShift as a Developer or Platform Engineer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-package/s4-apps-lab.html">Lab: Deploy Kubernetes Applications in MicroShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-package/s5-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Deploy MicroShift on RHEL Image Mode</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s1-microshift-bootc.html">Bootc Container Images With MicroShift</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s2-image-lab.html">Lab: Create Bootc Container Images with MicroShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s4-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Deploying MicroShift on RHEL Image Mode</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../rhde-microshift/1/index.html">Deploying MicroShift on Red Hat Device Edge</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../rhde-microshift/1/index.html">1</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../index.html">Deploying MicroShift on RHEL Image Mode</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../samples/1/index.html">samples</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../samples/1/index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Deploying MicroShift on RHEL Image Mode</a></li>
    <li><a href="index.html">Deploy MicroShift on RHEL Image Mode</a></li>
    <li><a href="s2-image-lab.html">Lab: Create Bootc Container Images with MicroShift</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Create Bootc Container Images with MicroShift</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>5 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Provision a RHEL image mode system with MicroShift, fully disconnected, from an installation ISO.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Work In Progress
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Rewrite this as needed for image mode, may extract pieces to partials if they fit both RPM-OSTree and bootc
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before you Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a few machines to perform the hands-on activities in this course.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <em>development machine</em> with RHEL and unrestricted <code>sudo</code>, where you will create KVM VMs using Libvirt, build bootc container iamges, run bootc image builder, and also run the OpenShift client to access your MicroShift instances.</p>
</li>
<li>
<p>A <em>package server machine</em> already configured to serve DNF repositories for RHEL, Fast Datapath for RHEL, and Red Hat OpenShift Container Platform.</p>
</li>
<li>
<p>A <em>web server machine</em> with RHEL and unrestricted <code>sudo</code>, to miscelaneous files for your RHEL and MicroShift VMs.</p>
</li>
<li>
<p>A <em>mirror registry machine</em> with RHEL and unrestricted <code>sudo</code>, already populated with the container images required by MicroShift and sample applications.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Make sure that your <em>package server machine</em> and <em>mirror registry machine</em> are properly configured and verified by following the instructions from a <a href="../ch1-microshift/s3-air-gapped-lab.html" class="xref page">previous lab</a> of this course.</p>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 9.5 but should work with minimal or no change on newer and older RHEL 9.x releases.</p>
</div>
<div class="paragraph">
<p>If you are using the course environment, you will log in to the <code>workstation</code> VM as the user <code>student</code> with password <code>student</code>. The <code>workstation</code> VM is your <em>development machine</em>. You will start SSH sessions from the <code>workstation</code> VM to the <code>servera</code> VM, which is your <em>web server machine</em> and also your <em>mirror registry machine</em>, using the same user.</p>
</div>
<div class="paragraph">
<p>You will also create a local KVM virtual machine on your <em>development machine</em>, and we refer to that VM as your <em>edge machine</em>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Be sure you execute each step on the correct machine. If a step is not explicit about the machine it should be performed, it is using the same machine as its previous step.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On your <em>development machine</em>, verify that you have all prerequisites from previous labs.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Check that you can access your <em>web server machine</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com</strong>
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"&gt;

&lt;html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"&gt;
        &lt;head&gt;
                &lt;title&gt;Test Page for the HTTP Server on Red Hat Enterprise Linux&lt;/title&gt;
...</code></pre>
</div>
</div>
</li>
<li>
<p>Check that your unprivileged user has access to Libvirt session VMs.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virsh uri</strong>
qemu:///session
$ <strong>virsh nodeinfo</strong>
CPU model:           x86_64
...</code></pre>
</div>
</div>
</li>
<li>
<p>Check that you have a valid pull secret for your your <em>mirror registry machine</em> and that you can access it with TLS validation enabled. [ Review this output because of bootc containers ]</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>podman search --authfile mirror-pull-secret servera.lab.example.com:8443/</strong>
NAME                                                                 DESCRIPTION
servera.lab.example.com:8443/lvms4/lvms-rhel9-operator
servera.lab.example.com:8443/openshift-release-dev/ocp-v4.0-art-dev
servera.lab.example.com:8443/rhel9/mysql-80
servera.lab.example.com:8443/flozanorht/php-ubi
servera.lab.example.com:8443/ubi9/ubi</code></pre>
</div>
</div>
</li>
<li>
<p>Check that output from the previous command shows that the mirror registry is already populated with MicroShift release images (<code>openshift-release-dev/ocp-v4.0-art-dev</code>) and LVM Storage operator images (<code>lvms4/lvms-rhel9-operator</code>).</p>
</li>
</ol>
</div>
</li>
<li>
<p>Configure the <em>development machine</em> to use the mirror registry, so it can build bootc container images without internet access.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Configure the container runtime to get MicroShift release images from the mirror registry.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The registry configuration file is the same one you already used to configure MicroShift in a <a href="#ch2-package:s2-install-lab">previous lab</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>wget -q https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/microshift/999-microshift-mirror.conf</strong>
$ <strong>sudo cp 999-microshift-mirror.conf /etc/containers/registries.conf.d</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Disable signature verification on container images required by MicroShift by downloading a <a href="https://github.com/RedHatQuickCourses/rhde-build-samples/blob/main/microshift/containers-policy.json.nosigs">container image policy file</a> from the course samples git repository.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>wget -q https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/microshift/containers-policy.json.nosigs</strong>
$ <strong>sudo cp containers-policy.json.nosigs /etc/containers/policy.json</strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Download and inspect a containerfile for a preconfigured MicroShift instance. That container file requires the files downloaded during the previous step, and a few more files you will download right now.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Download the <a href="https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/microshift/Containerfile-bootc">sample containerfile</a> from the course samples git repository. It is a long Containerfile but, assuming that you performed all activities from the the <a href="#ch2-package">previous chapter</a> of this course, there should be no surprises.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>wget -q https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/microshift/Containerfile-bootc</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Review the <code>Containerfile-bootc</code> file and make sure you understand its instructions:</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The code snippets here help you locate the relevant sections in the Containerfile, but they do not list the entirety of most sections. Follow along with a text editor and navigate through the blueprint file.
</td>
</tr>
</table>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Use the base RHEL 9 bootc container as the base image.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">FROM servera.lab.example.com:8443/rhel9/rhel-bootc:9.5
...</code></pre>
</div>
</div>
</li>
<li>
<p>Configure DNF repositories</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
COPY yum.d/* /etc/yum.repos.d/
...</code></pre>
</div>
</div>
</li>
<li>
<p>Install the MicroShift packages and dependencies. You need the optional <code>microshift-release-info</code> package because it provides the list of container images to embed in the bootc container image, later in this containerfile.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
RUN dnf install -y firewalld microshift microshift-release-info &amp;&amp; \
    systemctl enable microshift &amp;&amp; \
    dnf clean all
...</code></pre>
</div>
</div>
</li>
<li>
<p>Enables the Kubernetes pod and service networks on the Linux firewall, and expose the Kubernetes API endpoint and SSH port.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
RUN firewall-offline-cmd --zone=trusted --add-source=10.42.0.0/16 &amp;&amp; \
    firewall-offline-cmd --zone=trusted --add-source=169.254.169.1 &amp;&amp; \
    firewall-offline-cmd --zone=public --add-port=22/tcp &amp;&amp; \
    firewall-offline-cmd --zone=public --add-port=6443/tcp
...</code></pre>
</div>
</div>
</li>
<li>
<p>Enable a first boot service, which sets file permissions required by OVN.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
RUN cat &gt; /etc/systemd/system/microshift-make-rshared.service &lt;&lt;'EOF'
[Unit]
Description=Make root filesystem shared
Before=microshift.service
ConditionVirtualization=container
[Service]
Type=oneshot
ExecStart=/usr/bin/mount --make-rshared /
[Install]
WantedBy=multi-user.target
EOF
RUN systemctl enable microshift-make-rshared.service
...</code></pre>
</div>
</div>
</li>
<li>
<p>Add a registry configuration which redirects MicroShift container images to the mirror registry.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
ADD 999-microshift-mirror.conf /etc/containers/registries.conf.d/999-microshift-mirror.conf
...</code></pre>
</div>
</div>
</li>
<li>
<p>Add an image policy which disables signature validation.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
ADD containers-policy.json.nosigs /etc/containers/policy.json
...</code></pre>
</div>
</div>
</li>
<li>
<p>Add a CA certificate for the mirror registry. Remember that you download that CA file in the <a href="../ch1-microshift/s3-air-gapped-lab.html" class="xref page">first chapter</a></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
ADD quay-rootCA.pem /etc/pki/ca-trust/source/anchors
RUN update-ca-trust
...</code></pre>
</div>
</div>
</li>
<li>
<p>Embed the MicroShift release container images in the system image.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
ENV IMAGE_STORAGE_DIR=/usr/lib/containers/storage
ENV IMAGE_LIST_FILE=${IMAGE_STORAGE_DIR}/image-list.txt

RUN --mount=type=secret,id=pullsecret,dst=/run/secrets/pull-secret.json \
    images="$(jq -r ".images[]" /usr/share/microshift/release/release-"$(uname -m)".json)" ; \
    mkdir -p "${IMAGE_STORAGE_DIR}" ; \
    for img in ${images} ; do \
        sha="$(echo "${img}" | sha256sum | awk '{print $1}')" ; \
        skopeo copy --all --preserve-digests \
            --authfile /run/secrets/pull-secret.json \
            "docker://${img}" "dir:$IMAGE_STORAGE_DIR/${sha}" ; \
        echo "${img},${sha}" &gt;&gt; "${IMAGE_LIST_FILE}" ; \
    done
...</code></pre>
</div>
</div>
</li>
<li>
<p>Embed a script which copies the autogenerated kubeconfig files to the <code>core</code> user home directory. [ PENDING, DO ON KICKSTART? OR IN THE CONTAINERFILE? ]</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
# TODO: Add a first-boot unit to copy the kubeconfig, like I did for OSTREE
...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The script starts before MicroShift is fully initialized so it was coded to wait until MicroShift autogenerates the kubeconfig files.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Download DNF repository configuration files that refer to the <em>package server machine</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>mkdir yum.d</strong>
$ <strong>wget -qP yum.d https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/microshift/yum.d/rhel-9.5-for-x86_64-baseos-rpms.repo</strong>
$ <strong>wget -qP yum.d https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/microshift/yum.d/rhel-9.5-for-x86_64-appstream-rpms.repo</strong>
$ <strong>wget -qP yum.d https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/microshift/yum.d/fast-datapath-for-rhel-9-x86_64-rpms.repo</strong>
$ <strong>wget -qP yum.d https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/microshift/yum.d/rhocp-4.17-for-rhel-9-x86_64-rpms.repo</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Embed a test application container image in the bootc container image [ TBD ]</p>
</li>
</ol>
</div>
</li>
<li>
<p>Download and inspect a blueprint for a customized installation ISO.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Download the <a href="https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/microshift/config.toml">sample installer blueprint</a> from the course samples git repository. It basically contains a customized kickstart file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>wget -q https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/microshift/config.toml</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Review the blueprint and make sure you understand it&#8217;s kickstart instructions.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The code snippets here help you locate the relevant sections in the kickstart file, but they do not list the entirety of the blueprint file. Follow along with a text editor and navigate through the kickstart file.
</td>
</tr>
</table>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Set a text-mode installation and preconfigure language and keyboard, so Anaconda can proceed unattended, and reboot at the end of the installation.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
lang en_US.UTF-8
keyboard us
timezone Etc/UTC --utc
text --non-interactive
rootpw --lock
reboot
...</code></pre>
</div>
</div>
</li>
<li>
<p>Partition the root disk with LVM, but taking only 10G for the root partition, in order to leave empty space in the <code>rhel</code> volume group for use by MicroShift&#8217;s LVM Storage operator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
zerombr
clearpart --all --initlabel
part /boot/efi --fstype=efi --size=200
part /boot --fstype=xfs --asprimary --size=800
part pv.01 --grow
volgroup rhel pv.01
logvol / --vgname=rhel --fstype=xfs --size=10240 --name=root
...</code></pre>
</div>
</div>
</li>
<li>
<p>In a post install script,  create an initial user with a known password, unlimited sudo, and SSH key.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
useradd -g wheel core
echo "core:redhat123" | chpasswd
mkdir /home/core/.ssh
cat &gt; /home/core/.ssh/authorized_keys &lt;&lt; EOFSSH
REPLACE_WTH_SSH_PUB_KEY
EOFSSH
...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Production systems would NOT enable password login. We left it here as a convenience for the learner, so you can log in at the VM console for troubleshooting.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Also in the post install script, add a pull secret for the mirror registry.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
cat &gt; /etc/crio/openshift-pull-secret &lt;&lt;EOFPULLS
REPLACE_WTH_PULL_SECRET
EOFPULLS
chmod 600 /etc/crio/openshift-pull-secret
...</code></pre>
</div>
</div>
</li>
<li>
<p>End the post install script by setting the hostname to <code>ushift</code> where the letter "u" stands for the Greek letter "micro", just for convenience.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
echo "ushift" &gt; /etc/hostname
chmod 644 /etc/hostname
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create an SSH key for use with your edge devices.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ssh-keygen -N '' -f edge-key -C 'initial key for edge devices'</strong>
Generating public/private rsa key pair.
...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you get an error, because you already have an <code>edge-key</code> generated from previous Red Hat Device Edge courses, just ignore the error and continue with the next step.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Embed your new SSH key in the blueprint.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>SSH_PUB_KEY=$( cat edge-key.pub )</strong>
$ <strong>sed -i "s|REPLACE_WITH_SSH_PUB_KEY|$SSH_PUB_KEY|" config.toml</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Embed your pull secret in the blueprint.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>PULL_SECRET=$( cat mirror-pull-secret )</strong>
$ <strong>sed -i "s|REPLACE_WITH_PULL_SECRET|$PULL_SECRET|" config.toml</strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Build a bootc container image and embed it into an installation ISO.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Build a bootc container image.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>podman build -f Containerfile-microshift -t rhde/microshift-bootc:4.17</strong>
GRAB OUTPUT</code></pre>
</div>
</div>
</li>
<li>
<p>Copy your bootc container image to the mirror registry.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>skopeo copy containers-storage:localhost/rhde/microshift-bootc:4.17 docker://servera.lab.example.com:8443/rhde/microshift-bootc:4.17</strong>
GRAB OUTPUT</code></pre>
</div>
</div>
</li>
<li>
<p>Pull your bootc container image to the system container storage, so it can be read by bootc image builder.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo podman pull servera.lab.example.com:8443/rhde/microshift-bootc:4.17</strong>
GRAB OUTPUT</code></pre>
</div>
</div>
</li>
<li>
<p>Create an installable ISO containing your bootc container image and your custom kickstart file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>mkdir output</strong>
$ <strong>sudo podman run --rm -it --privileged --pull=newer \
    --security-opt label=type:unconfined_t \
    -v /var/lib/containers/storage:/var/lib/containers/storage \
    -v $(pwd)/config.toml:/config.toml \
    -v $(pwd)/output:/output \
    servera.lab.example.com:8443/rhel9/bootc-image-builder:9.5 \
    --type iso --local --config /config.toml \
    servera.lab.example.com:8443/rhde/microshift-bootc:4.17</strong>
GRAB OUTPUT</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the installable ISO from the bootc image builder temporary output directory to a more permanent localtion, and give it an easily identifiable name. That file would be distributed to personel responsible for installing actual edge devices.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>cp output/bootiso/install.iso rhel9-microshift-bootc.iso</strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your <em>web server machine</em>, stop the mirror registry for Red Hat OpenShift, so you can prove that your installation disk can actually work in disconnected edge sites.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo systemctl stop quay-app quay-pod quay-redis</strong>
$ <strong>sudo systemctl is-active quay-app quay-pod quay-redis</strong>
failed
inactive
inactive</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>failed</code> state is expected for the <code>quay-app</code> service.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>On your <em>development machine</em>, create a KVM virtual machine to test your edge installer image.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Set a shell variable with the disk label of your installer image, by copy-and-paste from the output of the <code>iso-info</code> command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>iso-info rhel9-microshift-bootc.iso</strong>
...
Volume      : RHEL-9-5-0-BaseOS-x86_64
No Joliet extensions
$ <strong>LABEL=RHEL-9-5-0-BaseOS-x86_64</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Create a KVM virtual machine from your installer image. The installation should proceed unattended until you get a login prompt.</p>
<div class="paragraph">
<p>You could use different <code>virt-install</code> commands or the Cockpit web UI. The use of <code>--location</code> and <code>--extra-arg</code> in the following command enables the VM to run with a serial console, so you don&#8217;t need to leave your shell and don&#8217;t need to open a graphical console for your <em>edge machine</em>. [ CAN I USE A RELATIVE PATH WITH --location ? ]</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virt-install --name edge-microshift-1 --os-variant rhel9.5 \
--memory 4096 --vcpus 2 --disk size=20 --graphics=none --network bridge=virbr0 \
--location /home/student/rhel9-microshift-bootc.iso \
--extra-arg inst.ks=hd:LABEL=$LABEL:/rhel9-microshift-installer.ks \
--extra-arg console=ttyS0 -v</strong>
...
ushift login:</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You may need to press <kbd>Enter</kbd> to see the login prompt, after the VM stops displaying console messages.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Detach from the VM console, by pressing <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>]</kbd></span>, and start an SSH session to your <em>edge machine</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ssh -i edge-key core@ushift</strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your <em>edge machine</em>, verify that MicroShift is fully initialized.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Check that MicroShift is healthy and all its pods are ready and running. Beware it may take a while for MicroShift to finish starting all its pods. [ ADD THE FIRST BOOT UNIT TO CREATE local-admin ]</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>export KUBECONFIG=~/local-admin</strong>
$ <strong>oc get node</strong>
NAME     STATUS   ROLES                         AGE   VERSION
ushift   Ready    control-plane,master,worker   10m   v1.30.5
$ <strong>oc get pod -A</strong>
NAMESPACE                  NAME                                       READY   STATUS    RESTARTS   AGE
kube-system                csi-snapshot-controller-69ddff88c8-6g4wr   1/1     Running   0          4m20s
kube-system                csi-snapshot-webhook-74dc497864-xgjzz      1/1     Running   0          4m24s
openshift-dns              dns-default-tj2wf                          2/2     Running   0          4m5s
openshift-dns              node-resolver-lfg6k                        1/1     Running   0          4m21s
openshift-ingress          router-default-575b4fc7-cnnsc              1/1     Running   0          4m19s
openshift-ovn-kubernetes   ovnkube-master-xc84v                       4/4     Running   0          4m21s
openshift-ovn-kubernetes   ovnkube-node-mgsz2                         1/1     Running   0          4m21s
openshift-service-ca       service-ca-9db855698-pwbfg                 1/1     Running   0          4m19s
openshift-storage          lvms-operator-7f544467bc-94227             1/1     Running   0          4m22s
openshift-storage          vg-manager-5n494                           1/1     Running   0          3m55s</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are too quick, you may get a <code>NotReady</code> state from <code>oc get node</code>, or a "no resources found" error from <code>oc get pod</code>. If any of this happens, just wait a few seconds and try again.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>As an additional check, create a test pod from the sample application image we included in the bootc container image. [ NOT YET ]</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>oc run shell -it --restart Never --image-pull-policy IfNotPresent --image servera.lab.example.com:8443/ubi9/ubi -- rpm -q redhat-release</strong>
redhat-release-9.5-0.6.el9.x86_64
$ <strong>oc delete pod shell</strong>
pod "shell" deleted</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you create a pod with the default image pull policy of <code>Always</code> it will fail because we stopped the mirror registry.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You succeed in provisioning an edge device, from an installable ISO, in an air-gapped environment: you only need the installation media to fully provision a ready-to-use RHEL image mode system running a MicroShift instance.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_whats_next"><a class="anchor" href="#_whats_next"></a>What&#8217;s Next</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This was the final activity of this course. If you wish, you can create service accounts and kubeconfig files for developer access using the same steps from ch2-package:s3-access-lab.adoc[previous labs] already demonstrated on RHEL package mode.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s1-microshift-bootc.html">Bootc Container Images With MicroShift</a></span>
  <span class="next"><a href="s4-summary.html">Summary</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
