<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Install MicroShift from RPM Packages :: Deploying MicroShift on Image Mode for RHEL</title>
    <link rel="prev" href="s1-install-config.html">
    <link rel="next" href="s3-access-lab.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Deploying MicroShift on Image Mode for RHEL</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/rhde-microshift-bootc/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rhde-microshift" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Deploying MicroShift on Red Hat Device Edge</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-microshift/index.html">Introduction to Red Hat Build of MicroShift</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-microshift/s1-microshift-vs-ocp.html">Introduction to MicroShift and Red Hat Device Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-microshift/s2-prepare-lab.html">Lab: Prepare a Test Environment for Red Hat Device Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-microshift/s3-air-gapped-lab.html">Lab: Prepare a Test Environment for MicroShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-microshift/s4-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Deploy MicroShift on RHEL Servers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s1-install-config.html">Install and Configure MicroShift on Package-Based RHEL</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s2-install-lab.html">Lab: Install MicroShift from RPM Packages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s3-access-lab.html">Lab: Access MicroShift as a Developer or Platform Engineer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s4-apps-lab.html">Lab: Deploy Kubernetes Applications in MicroShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s5-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch3-image/index.html">Deploy MicroShift on Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-image/s1-microshift-edge.html">RHEL for Edge images With MicroShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-image/s2-image-lab.html">Lab: Create RHEL for Edge Images with MicroShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-image/s4-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Deploying MicroShift on Red Hat Device Edge</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../rhde-microshift-bootc/1/index.html">Deploying MicroShift on Image Mode for RHEL</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../rhde-microshift-bootc/1/index.html">1</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../index.html">Deploying MicroShift on Red Hat Device Edge</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../samples/1/index.html">samples</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../samples/1/index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../rhde-microshift-bootc/1/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Deploying MicroShift on Red Hat Device Edge</a></li>
    <li><a href="index.html">Deploy MicroShift on RHEL Servers</a></li>
    <li><a href="s2-install-lab.html">Lab: Install MicroShift from RPM Packages</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Install MicroShift from RPM Packages</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>13 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Install MicroShift in a RHEL VM that is <em>not</em> connected to the internet.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before You Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a <em>test machine</em> with RHEL and unrestricted <code>sudo</code>, on which you will install MicroShift.</p>
</div>
<div class="paragraph">
<p>You also need a <em>package server machine</em> already configured to serve DNF repositories for RHEL, Fast Datapath for RHEL, and Red Hat OpenShift Container Platform.</p>
</div>
<div class="paragraph">
<p>Finally, you need a <em>mirror registry machine</em> with RHEL and unrestricted <code>sudo</code>, already populated with the container iamges required bu MicroShoft and sample applications.</p>
</div>
<div class="paragraph">
<p>Make sure that your <em>package server machine</em> and <em>mirror registry machine</em> are properly configured and verified by following the instructions from the <a href="../ch1-microshift/s3-air-gapped-lab.html" class="xref page">previous lab</a> of this course.</p>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 9.5 but should work with minimal or no change on newer and older RHEL 9.x releases.</p>
</div>
<div class="paragraph">
<p>If you are using the course classroom, log in to the <code>workstation</code> VM as the user <code>student</code> with password <code>student</code>, and start SSH sessions from <code>workstation</code> VM to the <code>serverb</code> VM, which is your <em>test machine</em>, using the same user. If not, please adapt the instructions to your test environment.</p>
</div>
<div class="paragraph">
<p>Perform all steps in this lab on your <em>test machine</em>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in to your <em>test machine</em> and verify that it has access to the required DNF package repositories.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Check that the required package repositories from RHEL and OpenShift are available.</p>
<div class="paragraph">
<p>On the classroom environment, you will find configuration files which point to the <em>package server machine</em> and the names of its DNF repositories match the names of Red Hat DNF repositories.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ls /etc/yum.repos.d</strong>
fast-datapath-for-rhel-9-x86_64-rpms.repo  rhel-9.5-for-x86_64-baseos-rpms.repo
rhel-9.5-for-x86_64-appstream-rpms.repo    rhocp-4.17-for-rhel-9-x86_64-rpms.repo
$ <strong>cat /etc/yum.repos.d/rhocp-4.17-for-rhel-9-x86_64-rpms.repo</strong>
[rhocp-4.17-for-rhel-9-x86_64-rpms]
baseurl = http://content.example.com/rhde/rpms/rhocp-4.17-for-rhel-9-x86_64-rpms
enabled = true
...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you were connected to the Internet, or to a Red Hat Satellite instance, and had registered your <em>test machine</em> with a valid Red Hat subscription, you would notice something similar to:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo dnf repolist</strong>
Updating Subscription Management repositories.
repo id                                                         repo name
fast-datapath-for-rhel-9-x86_64-rpms                            Fast Datapath for RHEL 9 x86_64 (RPMs)
rhel-9-for-x86_64-appstream-rpms                                Red Hat Enterprise Linux 9 for x86_64 - AppStream (RPMs)
rhel-9-for-x86_64-baseos-rpms                                   Red Hat Enterprise Linux 9 for x86_64 - BaseOS (RPMs)
rhocp-4.17-for-rhel-9-x86_64-rpms                               Red Hat OpenShift Container Platform 4.17 for RHEL 9 x86_64 (RPMs)</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Please do <em>not</em> register any VM on your virtual labs. Conserve the limited internet bandwidth that is shared by all learners using ROLE.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>As an additional validation, search for packages from the OpenShift and Fast Datapath repositories.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>dnf search microshift</strong>
...
microshift.x86_64 : MicroShift service
microshift-greenboot.noarch : Greenboot components for MicroShift
...
$ <strong>dnf search ovn24.09-central</strong>
...
ovn24.09-central.x86_64 : Open Virtual Network support</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Verify that your <em>test machine</em> can access a mirror container image registry that is pre-populated with the container images required by MicroShift.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Install the <code>container-tools</code> package, if it is not already installed on your <em>test machine</em>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is <em>not</em> strictly required to run MicroShift; however, it provides troubleshooting tools, which can be valuable in a development environment.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo dnf install container-tools</strong>
...
Complete!</code></pre>
</div>
</div>
</li>
<li>
<p>Add the CA key of the mirror registry to the set of trusted CAs. The public CA key is available from the <em>web server machine</em>, which in the classroom environment is also the <em>mirror registry machine</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>wget -q http://servera.lab.example.com/quay-rootCA.pem</strong>
$ <strong>sudo cp quay-rootCA.pem /etc/pki/ca-trust/source/anchors</strong>
$ <strong>sudo update-ca-trust</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Create a pull secret, which enables access to the MicroShift container images.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In a deployment connected to the internet, you would get a pull secret from your Red Hat account from the Red Hat Hybrid Cloud Console.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Please, do <em>not</em> use your pull secret with VMs on your virtual labs. Please stick to the scenario of an air-gaped deployment of MicroShift, assuming that an IT Operations team already configured all local network infrastructure required for deploying Red Hat Device Edge.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For the classroom environment, the pull secret for the mirror registry is also available from <a href="https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/microshift/mirror-pull-secret">GitHub</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>podman login -u microshift -p redhat123 servera.lab.example.com:8443</strong>
Login Succeeded!
$ <strong>cp $XDG_RUNTIME_DIR/containers/auth.json mirror-pull-secret</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Check that you can use the pull secret to inspect container images on the mirror registry. It should work with TLS validation enabled, which is the default for all container tools.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>skopeo inspect --authfile mirror-pull-secret -f '{{.RepoTags}}' docker://servera.lab.example.com:8443/ubi9/ubi</strong>
[latest]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The command would work with your actual Red Hat pull secret if you change the registry part of the container image name to <code>redhat.registry.io</code>; however, it would display a long list of tags.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Verify that your <em>test machine</em> is configured to support the installation of MicroShift.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>MicroShift expects that SELinux is enabled, in enforcing mode, and that Firewalld is enabled. Please do not disable any of them; there&#8217;s no need!</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>getenforce</strong>
Enforcing
$ <strong>systemctl is-enabled firewalld</strong>
enabled
$ <strong>sudo firewall-cmd --list-all</strong>
[sudo] password for student:
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: eth0 eth1
  sources:
  services: cockpit dhcpv6-client pulseaudio ssh
  ports: 8888/tcp
  protocols:
  forward: no
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enable more services and trusted zones or interfaces as you need. Later in this course, you&#8217;ll learn what to add to enable remote access to MicroShift and Kubernetes applications on it.</p>
</div>
</li>
<li>
<p>Check that you have two CPU cores, or two virtual CPUs, and at least 2GB of memory. If you are using the classroom environment, you have more memory than required on the <code>serverb</code> VM.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>nproc</strong>
2
$ <strong>free -h</strong>
               total        used        free      shared  buff/cache   available
Mem:           3.6Gi       803Mi       2.6Gi        27Mi       456Mi       2.8Gi
Swap:             0B          0B          0B</code></pre>
</div>
</div>
</li>
<li>
<p>Check that you have some GB of free disk space on whatever file system holds <code>/var/lib/containers</code> so you can store container images and ephemeral storage layers from CRI-O containers.</p>
<div class="paragraph">
<p>In the classroom environment, it is on the root partition of the <code>serverb</code> VM.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>df -h /var/lib/containers</strong>
Filesystem      Size  Used Avail Use% Mounted on
/dev/vda4       9.4G  2.6G  6.8G  28% /</code></pre>
</div>
</div>
</li>
<li>
<p>Check that you have a volume group named <code>rhel</code> with a few GB of unallocated space, so you can create Persistent Volumes (PVs) for your Kubernetes applications.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo vgs</strong>
  VG   #PV #LV #SN Attr   VSize   VFree
  rhel   1   0   0 wz--n- &lt;10.00g &lt;10.00g</code></pre>
</div>
</div>
</li>
<li>
<p>Check that your <em>test machine</em> is not using the network ranges used by the <a href="https://github.com/openshift/microshift/blob/main/docs/user/howto_firewall.md">Kubernetes virtual networks</a> or the OpenShift ingress IP address, which are 10.42.0.0/16 to 10.44.0.0/16 and 169.254.169.1.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ip -br addr show</strong>
lo               UNKNOWN        127.0.0.1/8 ::1/128
eth0             UP             172.25.250.11/24 fe80::5054:ff:fe00:fa0b/64
eth1             UP             10.80.0.156/16 fe80::2d83:182f:c10a:438b/64
$ <strong>route -n</strong>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         172.25.250.254  0.0.0.0         UG    100    0        0 eth0
10.80.0.0       0.0.0.0         255.255.0.0     U     101    0        0 eth1
169.254.169.254 10.80.0.10      255.255.255.255 UGH   101    0        0 eth1
172.25.250.0    0.0.0.0         255.255.255.0   U     100    0        0 eth0</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Install the MicroShift packages.</p>
<div class="paragraph">
<p>You need only one package, called <code>microshift</code>, but pay attention to its dependency list. Notice that it includes packages from OpenShift, such as <code>cri-o</code>; packages from RHEL for Edge, like <code>greenboot</code>; and also packages from Fast Datapath for RHEL 9, which provide Open Virtual Networking (OVN).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo dnf install microshift</strong>
...
Installing:
 microshift                            x86_64      4.17.3-202410241116.p0.gec0b5ea.assembly.4.17.3.el9        rhocp-4.17-for-rhel-9-x86_64-rpms          53 M
Installing dependencies:
 NetworkManager-ovs                    x86_64      1:1.46.0-4.el9_4                                           rhel-9.4-for-x86_64-appstream-rpms         65 k
 conntrack-tools                       x86_64      1.4.7-2.el9                                                rhel-9.4-for-x86_64-appstream-rpms        239 k
 cri-o                                 x86_64      1.30.6-6.rhaos4.17.git6ac6e96.el9                          rhocp-4.17-for-rhel-9-x86_64-rpms          18 M
 cri-tools                             x86_64      1.30.0-5.el9                                               rhocp-4.17-for-rhel-9-x86_64-rpms          10 M
 greenboot                             x86_64      0.15.4-1.el9                                               rhel-9.4-for-x86_64-appstream-rpms         41 k
 libnetfilter_cthelper                 x86_64      1.0.0-22.el9                                               rhel-9.4-for-x86_64-appstream-rpms         26 k
 libnetfilter_cttimeout                x86_64      1.0.0-19.el9                                               rhel-9.4-for-x86_64-appstream-rpms         25 k
 libnetfilter_queue                    x86_64      1.0.5-1.el9                                                rhel-9.4-for-x86_64-appstream-rpms         31 k
 microshift-greenboot                  noarch      4.17.3-202410241116.p0.gec0b5ea.assembly.4.17.3.el9        rhocp-4.17-for-rhel-9-x86_64-rpms          21 k
 microshift-networking                 x86_64      4.17.3-202410241116.p0.gec0b5ea.assembly.4.17.3.el9        rhocp-4.17-for-rhel-9-x86_64-rpms          21 k
 microshift-selinux                    noarch      4.17.3-202410241116.p0.gec0b5ea.assembly.4.17.3.el9        rhocp-4.17-for-rhel-9-x86_64-rpms          26 k
 openshift-clients                     x86_64      4.17.0-202410161505.p0.g897ef0b.assembly.stream.el9        rhocp-4.17-for-rhel-9-x86_64-rpms          54 M
 openvswitch-selinux-extra-policy      noarch      1.0-36.el9fdp                                              fast-datapath-for-rhel-9-x86_64-rpms       11 k
 openvswitch3.4                        x86_64      3.4.0-1.el9fdp                                             fast-datapath-for-rhel-9-x86_64-rpms      6.8 M
 rpm-ostree                            x86_64      2024.3-1.el9                                               rhel-9.4-for-x86_64-appstream-rpms        4.1 M
 rpm-ostree-libs                       x86_64      2024.3-1.el9                                               rhel-9.4-for-x86_64-appstream-rpms         25 k
 runc                                  x86_64      4:1.1.14-2.rhaos4.17.el9                                   rhocp-4.17-for-rhel-9-x86_64-rpms         3.2 M
 unbound-libs                          x86_64      1.16.2-3.el9_3.3                                           rhel-9.4-for-x86_64-appstream-rpms        553 k

Transaction Summary
==============================================================================================================================================================
Install  19 Packages
...
Complete!</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Do not try to start MicroShift yet!
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Configure MicroShift to use your mirror registry.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Check the presence of the MicroShift configuration directory. You do <em>not</em> need to make any changes, and the files there just inform about their default configuration values.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ ls <strong>/etc/microshift</strong>
config.yaml.default  lvmd.yaml.default  manifests  manifests.d  ovn.yaml.default</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the pull secret to the CRI-O configuration directory, so MicroShift uses it for pulling container images for any pod, in any namespace.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo cp mirror-pull-secret /etc/crio/openshift-pull-secret</strong>
$ <strong>sudo chmod 600 /etc/crio/openshift-pull-secret</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Download a CRI-O registry configuration, from the course <a href="https://github.com/RedHatQuickCourses/rhde-build-samples/blob/main/microshift/999-microshift-mirror.conf">samples repository</a>, that redirects container images from Red Hat Registries and Quay.io to the mirror registry.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>wget -q https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/microshift/999-microshift-mirror.conf</strong>
$ <strong>head -n 5 999-microshift-mirror.conf</strong>
[[registry]]
    prefix = ""
    location = "servera.lab.example.com:8443" 
    mirror-by-digest-only = true
    insecure = false
...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This registry configuration only affects MicroShift release iamges. You may want to change it to include images from add-on operators and your applications. In this course, we will refer to application images by the mirror registry.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Copy the registry configuration to the container tools registries configuration directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo cp 999-microshift-mirror.conf /etc/containers/registries.conf.d/999-microshift-mirror.conf</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Download a CRI-O image policy, from the course <a href="https://github.com/RedHatQuickCourses/rhde-build-samples/blob/main/microshift/containers-policy.json.nosigs">samples repository</a>, that allows running any container image, from anywhere, without checking image signatures.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>wget -q https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/microshift/containers-policy.json.nosigs</strong>
$ <strong>cat containers-policy.json.nosigs</strong>
{
	"default": [
    	{
        	"type": "insecureAcceptAnything"
    	}
	],
	"transports":
    	{
        	"docker-daemon":
            	{
                	"": [{"type":"insecureAcceptAnything"}]
            	}
    	}
}</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the image policy to the container tools registries configuration directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo cp containers-policy.json.nosigs /etc/containers/policy.json</strong></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you skip that step, some Red Hat add-on operator images will fail to pull from the mirror registry.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Configure the system firewall and start MicroShift.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allow network traffic on the Kubernetes virtual network.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is <em>not</em> yet allowing network traffic from outside of your <em>test machine</em> to MicroShift and its applications. It is only allowing network traffic between Kubernetes pods and between the <em>test machine</em> and MicroShift.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo firewall-cmd --permanent --zone=trusted --add-source=10.42.0.0/16</strong>
success
$ <strong>sudo firewall-cmd --permanent --zone=trusted --add-source=169.254.169.1</strong>
success
$ <strong>sudo firewall-cmd --reload</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Enable and start MicroShift.</p>
<div class="paragraph">
<p>Be patient, it will take a few moments for MicroShift to generate Kubernetes configuration files, pull all its containers, and starts it daemons and pods. Note that it will <em>not</em> be ready yet when the <code>systemctl</code> command returns.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo systemctl enable microshift --now</strong>
Created symlink /etc/systemd/system/multi-user.target.wants/microshift.service → /usr/lib/systemd/system/microshift.service.
Created symlink /etc/systemd/system/multi-user.target.wants/microshift-cleanup-kubelet.service → /usr/lib/systemd/system/microshift-cleanup-kubelet.service.</code></pre>
</div>
</div>
</li>
<li>
<p>Check that the microshift service, which includes the Kubernetes core daemons, has started, and shows no errors on its logs. Be aware that having a healthy MicroShift service does <em>not</em> mean it&#8217;s fully ready and available.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo systemctl status microshift</strong>
● microshift.service - MicroShift
     Loaded: loaded (/usr/lib/systemd/system/microshift.service; enabled; preset: disabled)
     Active: active (running) since Thu 2024-11-21 22:30:19 UTC; 4s ago
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Verify that MicroShift is fully initialized.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Copy the autogenerated kubeconfig file to your home directory and change its ownership so you can read it from your unprivileged user. Do <em>not</em> let that file stay read-write; ensure it remains unchanged so you can use it in an emergency.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo cp /var/lib/microshift/resources/kubeadmin/kubeconfig ~/local-admin</strong>
$ <strong>sudo chown student:student ~/local-admin</strong>
$ <strong>chmod a-w ~/local-admin</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Check that all pods running on MicroShift are running and all their containers are ready. It may take a while, so repeat the following command until all pods are fully ready and running.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>oc --kubeconfig ~/local-admin get pod -A</strong>
NAMESPACE              	NAME                                   	READY   STATUS	RESTARTS    	AGE
kube-system            	csi-snapshot-controller-69ddff88c8-hr9dt   1/1 	Running   0           	6m37s
kube-system            	csi-snapshot-webhook-74dc497864-hfdw7  	1/1 	Running   0           	6m41s
openshift-dns          	dns-default-9z4ph                      	2/2 	Running   0           	5m55s
openshift-dns          	node-resolver-prvjx                    	1/1 	Running   0           	6m39s
openshift-ingress      	router-default-575b4fc7-tg5lz          	1/1 	Running   0           	6m37s
openshift-ovn-kubernetes   ovnkube-master-wj4gv                   	4/4 	Running   1 (5m57s ago)   6m39s
openshift-ovn-kubernetes   ovnkube-node-fdpm8                     	1/1 	Running   1 (5m58s ago)   6m39s
openshift-service-ca   	service-ca-9db855698-zd7vg             	1/1 	Running   0           	6m36s
openshift-storage      	lvms-operator-7f544467bc-cqf2n         	1/1 	Running   0           	6m40s
openshift-storage      	vg-manager-tjrs2                       	1/1 	Running   0           	5m25s</code></pre>
</div>
</div>
</li>
<li>
<p>As an additional validation, verify that your Kubernetes cluster contains one node that takes the roles of both control plane and worker node.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>oc --kubeconfig ~/local-admin get node</strong>
NAME 	STATUS   ROLES                     	AGE 	VERSION
rhelvm   Ready	control-plane,master,worker   7m31s   v1.30.5</code></pre>
</div>
</div>
</li>
<li>
<p>Check the presence of the virtual network bridges and interfaces used by Kubernetes virtual networks.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ip -br addr show</strong>
lo               UNKNOWN        127.0.0.1/8 ::1/128
eth0             UP             172.25.250.11/24 fe80::5054:ff:fe00:fa0b/64
eth1             UP             10.80.0.156/16 fe80::2d83:182f:c10a:438b/64
ovs-system       DOWN
br-ex            UNKNOWN        10.44.0.0/32 169.254.169.2/29
br-int           UNKNOWN
ovn-k8s-mp0      UNKNOWN        10.42.0.2/24 fe80::50:70ff:feaa:25e2/64
0ef8475e7471f6c@if2 UP             fe80::f860:c6ff:fe76:39ce/64
23e82273294fb87@if2 UP             fe80::24b6:c5ff:fe6b:3086/64
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will be longer as you create more pods, because each one gets a virtual network interface. Notice the two kernel bridges, named <code>br-ex</code> and <code>br-int</code>, and the OVN switch, named <code>ovn-k8s-mp0</code>.</p>
</div>
</li>
<li>
<p>Check the presence of the routing rules, which enable communication between your real networks and Kubernetes virtual networks.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo route -n</strong>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         172.25.250.254  0.0.0.0         UG    100    0        0 eth0
10.42.0.0       0.0.0.0         255.255.255.0   U     0      0        0 ovn-k8s-mp0
10.42.0.0       10.42.0.1       255.255.0.0     UG    0      0        0 ovn-k8s-mp0
10.43.0.0       169.254.169.4   255.255.0.0     UG    0      0        0 br-ex
10.80.0.0       0.0.0.0         255.255.0.0     U     101    0        0 eth1
169.254.169.0   0.0.0.0         255.255.255.248 U     0      0        0 br-ex
169.254.169.1   0.0.0.0         255.255.255.255 UH    0      0        0 br-ex
169.254.169.3   10.42.0.1       255.255.255.255 UGH   0      0        0 ovn-k8s-mp0
169.254.169.254 10.80.0.10      255.255.255.255 UGH   101    0        0 eth1
172.25.250.0    0.0.0.0         255.255.255.0   U     100    0        0 eth0</code></pre>
</div>
</div>
</li>
<li>
<p>Finally, check that you can create new pods.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>oc --kubeconfig ~/local-admin run shell -it --restart Never --image servera.lab.example.com:8443/ubi9/ubi -- rpm -q redhat-release</strong>
redhat-release-9.5-0.6.el9.x86_64
$ <strong>oc --kubeconfig ~/local-admin delete pod shell</strong>
pod "shell" deleted</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You now have a fully functional deployment of MicroShift in a RHEL machine. If you find that any of the MicroShift pods failed to start, the most likely cause is an error in your registry mirror and image policy configurations.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The way you configured MicroShift, it does <em>not</em> contain a pull secret to download container images from Red Hat, even if it has access to the internet. It can only pull containers from a mirror registry, which is usually what organizations with strict security policies would demand.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You probably wouldn&#8217;t want to perform development from the machine running MicroShift, so in the next activity, you will configure MicroShift for remote access and also an unprivileged user, without full Kubernetes administration rights.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s1-install-config.html">Install and Configure MicroShift on Package-Based RHEL</a></span>
  <span class="next"><a href="s3-access-lab.html">Lab: Access MicroShift as a Developer or Platform Engineer</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
