<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Create RHEL for Edge Images with MicroShift :: Deploying MicroShift on RHEL Image Mode</title>
    <link rel="prev" href="s1-microshift-edge.html">
    <link rel="next" href="s4-summary.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Deploying MicroShift on RHEL Image Mode</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/rhde-microshift-bootc/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rhde-microshift" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Deploying MicroShift on Red Hat Device Edge</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-microshift/index.html">Introduction to Red Hat Build of MicroShift</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-microshift/s1-microshift-vs-ocp.html">Introduction to MicroShift and Red Hat Device Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-microshift/s2-prepare-lab.html">Lab: Prepare a Test Environment for Red Hat Device Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-microshift/s3-air-gapped-lab.html">Lab: Prepare a Test Environment for MicroShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-microshift/s4-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch2-package/index.html">Deploy MicroShift on RHEL Servers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-package/s1-install-config.html">Install and Configure MicroShift on Package-Based RHEL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-package/s2-install-lab.html">Lab: Install MicroShift from RPM Packages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-package/s3-access-lab.html">Lab: Access MicroShift as a Developer or Platform Engineer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-package/s4-apps-lab.html">Lab: Deploy Kubernetes Applications in MicroShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-package/s5-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Deploy MicroShift on Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s1-microshift-edge.html">RHEL for Edge images With MicroShift</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s2-image-lab.html">Lab: Create RHEL for Edge Images with MicroShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s4-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Deploying MicroShift on Red Hat Device Edge</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Deploying MicroShift on Red Hat Device Edge</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../rhde-microshift-bootc/1/index.html">Deploying MicroShift on RHEL Image Mode</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../rhde-microshift-bootc/1/index.html">1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../samples/1/index.html">samples</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../samples/1/index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../rhde-microshift-bootc/1/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Deploying MicroShift on Red Hat Device Edge</a></li>
    <li><a href="index.html">Deploy MicroShift on Edge Devices</a></li>
    <li><a href="s2-image-lab.html">Lab: Create RHEL for Edge Images with MicroShift</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Create RHEL for Edge Images with MicroShift</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>15 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Build RHEL for Edge Images with MicroShift, using Image Builder, and publish them on remote OSTree repositories.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before you Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a few machines to perform the hands-on activities in this course.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <em>development machine</em> with RHEL and unrestricted <code>sudo</code>, where you will install Image Builder and RPM-OSTree tools, create KVM VMs using Libvirt, and also run the OpenShift client to access your MicroShift instances in other machines.</p>
</li>
<li>
<p>A <em>package server machine</em> already configured to serve DNF repositories for RHEL, Fast Datapath for RHEL, and Red Hat OpenShift Container Platform.</p>
</li>
<li>
<p>A <em>web server machine</em> with RHEL and unrestricted <code>sudo</code>, to host OSTree repositories</p>
</li>
<li>
<p>A <em>mirror registry machine</em> with RHEL and unrestricted <code>sudo</code>, already populated with the container images required by MicroShift and sample applications.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Make sure that your <em>package server machine</em> and <em>mirror registry machine</em> are properly configured and verified by following the instructions from the <a href="../ch1-microshift/s3-air-gapped-lab.html" class="xref page">previous lab</a> of this course.</p>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 9.5 but should work with minimal or no change on newer and older RHEL 9.x releases.</p>
</div>
<div class="paragraph">
<p>If you are using the course environment, you will log in to the <code>workstation</code> VM as the user <code>student</code> with password <code>student</code>. The <code>workstation</code> VM is your <em>development machine</em>. You will start SSH sessions from the <code>workstation</code> VM to the <code>servera</code> VM, which is your <em>web server machine</em> and also your <em>mirror registry machine</em>, using the same user.</p>
</div>
<div class="paragraph">
<p>You will also create a local KVM virtual machine on your <em>development machine</em>, and we refer to that VM as your <em>edge machine</em>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Be sure you execute each step on the correct machine. If a step is not explicit about the machine it should be performed, it is using the same machine as its previous step.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On your <em>development machine</em>, verify that you have all prerequisites from previous labs.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Check that the Image Builder service is running and your unprivileged user has access to it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>systemctl is-active osbuild-composer.socket</strong>
active
$ <strong>composer-cli compose types</strong>
ami
edge-ami
edge-commit
edge-container
edge-installer
...</code></pre>
</div>
</div>
</li>
<li>
<p>Check that the Image Builder service is configured with repository overrides for RHEL packages.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli sources list</strong>
appstream
baseos
$ <strong>composer-cli sources info baseos</strong>
check_gpg = true
...
url = "http://content.example.com/rhel9.5/x86_64/dvd/BaseOS"</code></pre>
</div>
</div>
</li>
<li>
<p>Check that you can access your <em>web server machine</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com</strong>
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"&gt;

&lt;html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"&gt;
        &lt;head&gt;
                &lt;title&gt;Test Page for the HTTP Server on Red Hat Enterprise Linux&lt;/title&gt;
...</code></pre>
</div>
</div>
</li>
<li>
<p>Check that your <em>web server machine</em> is already serving an OSTree repository.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If it isn&#8217;t, this lab will show how to configure it.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com/repo/config</strong>
[core]
repo_version=1
mode=archive-z2</code></pre>
</div>
</div>
</li>
<li>
<p>Check that your unprivileged user has access to Libvirt session VMs.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virsh uri</strong>
qemu:///session
$ <strong>virsh nodeinfo</strong>
CPU model:           x86_64
...</code></pre>
</div>
</div>
</li>
<li>
<p>Check that you have a valid pull secret for your your <em>mirror registry machine</em> and that you can access it with TLS validation enabled.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>podman search --authfile mirror-pull-secret servera.lab.example.com:8443/</strong>
NAME                                                                 DESCRIPTION
servera.lab.example.com:8443/lvms4/lvms-rhel9-operator
servera.lab.example.com:8443/openshift-release-dev/ocp-v4.0-art-dev
servera.lab.example.com:8443/rhel9/mysql-80
servera.lab.example.com:8443/flozanorht/php-ubi
servera.lab.example.com:8443/ubi9/ubi</code></pre>
</div>
</div>
</li>
<li>
<p>Check that output from the previous command shows that the mirror registry is already populated with MicroShift release images (<code>openshift-release-dev/ocp-v4.0-art-dev</code>) and LVM Storage operator images (<code>lvms4/lvms-rhel9-operator</code>).</p>
</li>
</ol>
</div>
</li>
<li>
<p>Configure the Image Builder service to use the mirror registry.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create an Image Builder worker configuration file that refers to credentials for accessing the mirror registry.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You already configured your <em>development machine</em> with CA certificates and credentials to access the mirror registry in a <a href="../ch1-microshift/s3-air-gapped-lab.html" class="xref page">previous lab</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo mkdir /etc/osbuild-worker</strong>
$ <strong>cat &gt; osbuild-worker.toml &lt;&lt; EOF
[containers]
auth_file_path = "/etc/osbuild-worker/containers-auth.json"
EOF</strong>
$ <strong>sudo cp osbuild-worker.toml /etc/osbuild-worker/osbuild-worker.toml</strong>
$ <strong>sudo cp mirror-pull-secret /etc/osbuild-worker/containers-auth.json</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Configure the container runtime to get MicroShift release images from the mirror registry.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The registry configuration file is the same one you already used to configure MicroShift in a <a href="#ch2-package:s2-install-lab">previous lab</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>wget -q https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/microshift/999-microshift-mirror.conf</strong>
$ <strong>sudo cp 999-microshift-mirror.conf /etc/containers/registries.conf.d</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Disable signature verification on container images required by MicroShift by downloading a <a href="https://github.com/RedHatQuickCourses/rhde-build-samples/blob/main/microshift/containers-policy.json.nosigs" class="bare">https://github.com/RedHatQuickCourses/rhde-build-samples/blob/main/microshift/containers-policy.json.nosigs</a>[container image policy file/ from the course samples git repository.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>wget -q https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/microshift/containers-policy.json.nosigs</strong>
$ <strong>sudo cp containers-policy.json.nosigs /etc/containers/policy.json</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Reboot your <em>development machine</em> so its Image Builder service reads its new configuration files.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Configure the Image Builder service with package sources for the RPM repositories required by MicroShift</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Download the package sources TOML files from the <a href="https://github.com/RedHatQuickCourses/rhde-build-samples/tree/main/sources">course samples git repository</a>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>wget -q https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/sources/openshift.toml</strong>
$ <strong>wget -q https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/sources/fastdata.toml</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Configure your Image Builder service with the additional package sources.</p>
<div class="paragraph">
<p>These package sources refer to the same RPM repositories that you already used in the <a href="../ch2-package/s2-install-lab.html" class="xref page">previous chapter</a> to deploy MicroShift on package-based RHEL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli sources add openshift.toml</strong>
$ <strong>composer-cli sources add fastdata.toml</strong>
$ <strong>composer-cli sources list</strong>
appstream
baseos
fastdata
openshift
$ <strong>composer-cli sources info openshift</strong>
...
url = "http://content.example.com/rhde/rpms/rhocp-4.17-for-rhel-9-x86_64-rpms"
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Download and inspect an Image Builder blueprint for a preconfigured MicroShift instance.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Download the <a href="https://github.com/RedHatQuickCourses/rhde-build-samples/blob/main/blueprints/rhel9-microshift.toml">sample blueprint</a> from the course samples git repository. It is a long blueprint but, assuming that you performed all activities from the <a href="https://redhatquickcourses.github.io/rhde-build/">first Red Hat Device Edge course</a> and also from the <a href="#ch2-package">previous chapter</a> of this course, there should be no surprises.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>wget -q https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/blueprints/rhel9-microshift.toml</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Review the <code>rhel9-microshift.toml</code> blueprint and make sure you understand its customizations:</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The code snippets here help you locate the relevant sections in the blueprint, but they do not list the entirety of most sections. Follow along with a text editor and navigate through the blueprint file.
</td>
</tr>
</table>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Set the hostname to <code>ushift</code> where the letter "u" stands for the Greek letter "micro".</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[customizations]
hostname = "ushift"</code></pre>
</div>
</div>
</li>
<li>
<p>Install the MicroShift packages and dependencies.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[packages]]
name = "microshift"</code></pre>
</div>
</div>
</li>
<li>
<p>Enable two first boot services, which are defined later in the blueprint.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[customizations.services]
enabled = ["sshd", "microshift", "firstboot-microshift", "firstboot-microshift-user" ]</code></pre>
</div>
</div>
</li>
<li>
<p>Expose the Kubernetes API endpoint.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[customizations.firewall]
ports = ["6443:tcp"]</code></pre>
</div>
</div>
</li>
<li>
<p>Add a pull secret for the mirror registry.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[customizations.files]]
path = "/etc/crio/openshift-pull-secret"
...</code></pre>
</div>
</div>
</li>
<li>
<p>Add a CA certificate for the mirror registry.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[customizations.files]]
path = "/etc/pki/ca-trust/source/anchors/quay-rootCA.pem"
...</code></pre>
</div>
</div>
</li>
<li>
<p>Add a registry configuration which redirects MicroShift container images to the mirror registry.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[customizations.files]]
path = "/etc/containers/registries.conf.d/999-microshift-mirror.conf"
...</code></pre>
</div>
</div>
</li>
<li>
<p>Add an image policy which disables signature validation.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[customizations.files]]
path = "/etc/containers/policy.json"
...</code></pre>
</div>
</div>
</li>
<li>
<p>Embed the MicroShift release container images in the system image.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[containers]]
source = "quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:98bcfe497a8550cff543321ba5c6535b9823aa4b091daf89ebba0bbcafa19208"

[[containers]]
source = "quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:1b0a5de3da8895f72deed91a79f4ecf83464370ce253494d28b8c98a1586bfc0"
...</code></pre>
</div>
</div>
</li>
<li>
<p>Embed a test application container in the system image.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[containers]]
source = "servera.lab.example.com:8443/ubi9/ubi"</code></pre>
</div>
</div>
</li>
<li>
<p>Embed a first boot service which configures the system&#8217;s firewall for the Kubernetes pod and service virtual networks.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[customizations.files]]
path = "/etc/systemd/system/firstboot-microshift.service"
...</code></pre>
</div>
</div>
</li>
<li>
<p>Embed a script which copies the autogenerated kubeconfig files to the <code>core</code> user home directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[customizations.files]]
path = "/etc/microshift/firstboot-microshift-user"
...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The script starts before MicroShift is fully initialized so it was coded to wait until MicroShift autogenerates the kubeconfig files.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Invoke the previous script from another first boot service.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[customizations.files]]
path = "/etc/systemd/system/firstboot-microshift-user.service"
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Build an edge system image.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add the CA certificate for the mirror registry to the blueprint. Because it was generated when you installed the mirror registry in a <a href="../ch1-microshift/s3-air-gapped-lab.html" class="xref page">previous lab</a>, we cannot have it in the course samples repository.</p>
<div class="paragraph">
<p>Open the <code>rhel9-microshift.toml</code> file in a text editor and replace the <code>REPLACE_QUAY_CA</code> text with the entire contents of the <code>quay-rootCA.pem</code> file.</p>
</div>
</li>
<li>
<p>Push the blueprint and check that Image Builder can resolve all RPM packages from it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli blueprints push rhel9-microshift.toml</strong>
$ <strong>composer-cli blueprints depsolve rhel9-microshift | grep microshift</strong>
blueprint: rhel9-microshift v0.1.0
    microshift-4.17.3-202410241116.p0.gec0b5ea.assembly.4.17.3.el9.x86_64
    microshift-greenboot-4.17.3-202410241116.p0.gec0b5ea.assembly.4.17.3.el9.noarch
    microshift-networking-4.17.3-202410241116.p0.gec0b5ea.assembly.4.17.3.el9.x86_64
    microshift-selinux-4.17.3-202410241116.p0.gec0b5ea.assembly.4.17.3.el9.noarch</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you get errors related to downloading container images, it is probably because you forgot to reboot your <em>development machine</em> after configuring it for accessing the mirror registry.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Start a compose for an edge commit image.</p>
<div class="paragraph">
<p>Save the UUID of the compose in a shell variable so you can use it in other commands.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose start-ostree rhel9-microshift edge-commit --ref rhel/9/x86_64/ushift</strong>
Warning: Please note that user customizations on "edge-commit" image type are deprecated and will be removed in the near future

Compose be27c45f-e1ea-42eb-94b3-a0789243bea4 added to the queue
$ <strong>UUID=be27c45f-e1ea-42eb-94b3-a0789243bea4</strong></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can ignore the warning about "user customizations" because the blueprint does not include any.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Wait until the compose finishes. Be patient, it will take a few minutes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose list</strong>
ID                                     Status     Blueprint          Version   Type
be27c45f-e1ea-42eb-94b3-a0789243bea4   RUNNING    rhel9-microshift   0.1.0     edge-commit
...
$ <strong>composer-cli compose list</strong>
ID                                     Status     Blueprint          Version   Type
be27c45f-e1ea-42eb-94b3-a0789243bea4   FINISHED   rhel9-microshift   0.1.0     edge-commit
...</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the edge commit image to your <em>web server machine</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose image $UUID</strong>
$ <strong>scp $UUID-commit.tar servera:~</strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your <em>web server machine</em>, publish your new edge system image.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Copy and paste the UUID from your <em>development machine</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>UUID=be27c45f-e1ea-42eb-94b3-a0789243bea4</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Extract your edge commit image and check it contains an OSTree repository.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>mkdir delete-me</strong>
$ <strong>tar xf $UUID-commit.tar -C delete-me/</strong>
$ <strong>ostree refs --repo delete-me/repo</strong>
rhel/9/x86_64/ushift</code></pre>
</div>
</div>
</li>
<li>
<p>If your web server already contains an OSTree repository from activities from previous Red Hat Device Edge courses, pull your edge container image into the same repository.</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Do NOT run the <code>pull-local</code> command if you do not have an OSTree repository in the web server!
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree --repo=/var/www/html/repo refs</strong>
rhel/9/x86_64/edge
$ <strong>sudo ostree pull-local --repo=/var/www/html/repo delete-me/repo</strong>
265 metadata, 649 content objects imported; 0 bytes content written</code></pre>
</div>
</div>
</li>
<li>
<p>If your web server does NOT contain an OSTree repository, just copy your edge commit image to the web server.</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you copy OSTree repository files over another OSTree repository, you may lose access to other OSTree commits previously stored in the OSTree repository. Only perform a file copy to an empty OSTree repository directory.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree --repo=/var/www/html/repo refs</strong>
error: opening repo: opendir(/var/www/html/repo): No such file or directory
$ <strong>sudo cp -r delete-me/repo /var/www/html</strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your <em>development machine</em>, download and inspect an Image Builder blueprint and a kickstart file for an edge installer image.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Download the <a href="https://github.com/RedHatQuickCourses/rhde-build-samples/blob/main/blueprints/rhel9-microshift-installer.toml">sample installer blueprint</a> from the course samples git repository. It is a minimal blueprint, without any customizations.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>wget -q https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/blueprints/rhel9-microshift-installer.toml</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Download the <a href="https://github.com/RedHatQuickCourses/rhde-build-samples/blob/main/ks/rhel9-microshift-installer.ks">sample installer kickstart</a> from the course samples git repository.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>wget -q https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/ks/rhel9-microshift-installer.ks</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Review the <code>rhel9-microshift-installer.ks</code> kickstart and make sure you understand it&#8217;s instructions.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The code snippets here help you locate the relevant sections in the kickstart file, but they do not list the entirety of the file. Follow along with a text editor and navigate through the kickstart file.
</td>
</tr>
</table>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Partition the root disk with LVM, but taking only 10G for the root partition, in order to leave empty space in the <code>rhel</code> volume group for use by MicroShift&#8217;s LVM Storage operator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">zerombr
clearpart --all --initlabel
part /boot/efi --fstype=efi --size=200
part /boot --fstype=xfs --asprimary --size=800
part pv.01 --grow
volgroup rhel pv.01
logvol / --vgname=rhel --fstype=xfs --size=10240 --name=root</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the OSTree commit embedded in the installation media.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">ostreesetup --nogpg --osname=rhel --remote=edge --url=file:///run/install/repo/ostree/repo --ref=rhel/9/x86_64/ushift</code></pre>
</div>
</div>
</li>
<li>
<p>Create an initial user with a known password, unlimited sudo, and SSH key.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">%post --log=/var/log/anaconda/post-install.log --erroronfail

# local user for console login and SSH
useradd -g wheel core
echo "core:redhat123" | chpasswd
mkdir /home/core/.ssh
cat &gt; /home/core/.ssh/authorized_keys &lt;&lt; EOFSSH
REPLACE_WTH_SSH_PUB_KEY
EOFSSH

%end</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Production systems would NOT enable password login. We left it here as a convenience for the learner, so you can log in at the VM console for troubleshooting.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create an SSH key for use with your edge devices.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ssh-keygen -N '' -f edge-key -C 'initial key for edge devices'</strong>
Generating public/private rsa key pair.
...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you get an error, because you already have an <code>edge-key</code> generated from previous Red Hat Device Edge courses, just ignore the error and continue with the next step.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Embed your new SSH key in the kickstart file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>SSH_PUB_KEY=$( cat edge-key.pub )</strong>
$ <strong>sed -i "s|REPLACE_WTH_SSH_PUB_KEY|$SSH_PUB_KEY|" rhel9-microshift-installer.ks</strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Build an edge installer image and download it as an ISO file.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Push the blueprint for your edge installer image.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli blueprints push rhel9-microshift-installer.toml</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Start a compose for your edge installer image.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose start-ostree microshift-installer edge-installer --ref rhel/9/x86_64/ushift --url http://servera.lab.example.com/repo/</strong>
Compose 170edc4e-9384-4e86-b616-7c09eaa718e4 added to the queue
$ <strong>UUID=170edc4e-9384-4e86-b616-7c09eaa718e4</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Wait until your compose finishes. It will take a few minutes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose list</strong>
ID                                     Status     Blueprint              Version   Type
170edc4e-9384-4e86-b616-7c09eaa718e4   RUNNING    microshift-installer   0.1.0     edge-installer
...
$ <strong>composer-cli compose list</strong>
ID                                     Status     Blueprint              Version   Type
170edc4e-9384-4e86-b616-7c09eaa718e4   FINISHED   microshift-installer   0.1.0     edge-installer</code></pre>
</div>
</div>
</li>
<li>
<p>Download your edge installer image.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose image $UUID</strong>
170edc4e-9384-4e86-b616-7c09eaa718e4-installer.iso</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Add your custom kickstart file to your installer ISO file.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Install the Lorax tools for manipulating Anaconda installation media.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo dnf install lorax</strong>
...
Complete!</code></pre>
</div>
</div>
</li>
<li>
<p>Create a new ISO file including your custom kickstart file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>mkksiso --ks rhel9-microshift-installer.ks $UUID-installer.iso rhel9-microshift.iso</strong>
...
Writing to '/home/student/rhel9-microshift.iso' completed successfully.</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your <em>web server machine</em>, stop the mirror registry for Red Hat OpenShift, so you can prove that your edge installer image can actually work in disconnected edge sites.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo systemctl stop quay-app quay-pod quay-redis</strong>
$ <strong>sudo systemctl is-active quay-app quay-pod quay-redis</strong>
failed
inactive
inactive</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>failed</code> state is expected for the <code>quay-app</code> service.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>On your <em>development machine</em>, create a KVM virtual machine to test your edge installer image.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Set a shell variable with the disk label of your installer image, by copy-and-paste from the output of the <code>iso-info</code> command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>iso-info rhel9-microshift.iso</strong>
...
Volume      : RHEL-9-5-0-BaseOS-x86_64
No Joliet extensions
$ <strong>LABEL=RHEL-9-5-0-BaseOS-x86_64</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Create a KVM virtual machine from your installer image. The installation should proceed unattended until you get a login prompt.</p>
<div class="paragraph">
<p>You could use different <code>virt-install</code> commands or the Cockpit web UI. The use of <code>--location</code> and <code>--extra-arg</code> in the following command enables the VM to run with a serial console, so you don&#8217;t need to leave your shell and don&#8217;t need to open a graphical console for your <em>edge machine</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virt-install --name edge-microshift-1 --os-variant rhel9.5 \
--memory 4096 --vcpus 2 --disk size=20 --graphics=none --network bridge=virbr0 \
--location /home/student/rhel9-microshift.iso \
--extra-arg inst.ks=hd:LABEL=$LABEL:/rhel9-microshift-installer.ks \
--extra-arg console=ttyS0 -v</strong>
...
ushift login:</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You may need to press <kbd>Enter</kbd> to see the login prompt, after the VM stops displaying console messages.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Detach from the VM console, by pressing <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>]</kbd></span>, and start an SSH session to your <em>edge machine</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ssh -i edge-key core@ushift</strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your <em>edge machine</em>, verify that MicroShift is fully initialized.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Check that MicroShift is healthy and all its pods are ready and running. Beware it may take a while for MicroShift to finish starting all its pods.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>export KUBECONFIG=~/local-admin</strong>
$ <strong>oc get node</strong>
NAME     STATUS   ROLES                         AGE   VERSION
ushift   Ready    control-plane,master,worker   10m   v1.30.5
$ <strong>oc get pod -A</strong>
NAMESPACE                  NAME                                       READY   STATUS    RESTARTS   AGE
kube-system                csi-snapshot-controller-69ddff88c8-6g4wr   1/1     Running   0          4m20s
kube-system                csi-snapshot-webhook-74dc497864-xgjzz      1/1     Running   0          4m24s
openshift-dns              dns-default-tj2wf                          2/2     Running   0          4m5s
openshift-dns              node-resolver-lfg6k                        1/1     Running   0          4m21s
openshift-ingress          router-default-575b4fc7-cnnsc              1/1     Running   0          4m19s
openshift-ovn-kubernetes   ovnkube-master-xc84v                       4/4     Running   0          4m21s
openshift-ovn-kubernetes   ovnkube-node-mgsz2                         1/1     Running   0          4m21s
openshift-service-ca       service-ca-9db855698-pwbfg                 1/1     Running   0          4m19s
openshift-storage          lvms-operator-7f544467bc-94227             1/1     Running   0          4m22s
openshift-storage          vg-manager-5n494                           1/1     Running   0          3m55s</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are too quick, you may get a <code>NotReady</code> state from <code>oc get node</code>, or a "no resources found" error from <code>oc get pod</code>. If any of this happens, just wait a few seconds and try again.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>As an additional check, create a test pod from the sample application image we included in the blueprint.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>oc run shell -it --restart Never --image-pull-policy IfNotPresent --image servera.lab.example.com:8443/ubi9/ubi -- rpm -q redhat-release</strong>
redhat-release-9.5-0.6.el9.x86_64
$ <strong>oc delete pod shell</strong>
pod "shell" deleted</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you create a pod with the default image pull policy of <code>Always</code> it will fail because we stopped the mirror registry.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You succeed in provisioning an edge device, from an edge installer image, in an air-gapped environment: you only need the installation media to fully provision a ready-to-use RHEL for Edge system running a MicroShift instance.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_whats_next"><a class="anchor" href="#_whats_next"></a>What&#8217;s Next</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This was the final activity of this course. If you wish, you can create service accounts and kubeconfig files for developer access using the same steps from ch2-package:s3-access-lab.adoc[previous labs] already demonstrated on package-based RHEL.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s1-microshift-edge.html">RHEL for Edge images With MicroShift</a></span>
  <span class="next"><a href="s4-summary.html">Summary</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
